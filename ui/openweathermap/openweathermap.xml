<?xml version="1.0" encoding="utf-8"?>
<!--
	Created by ApplusForm.com on 2014.3.26

	Permission is granted to copy, distribute, modify under the terms of ApplusForm License.

	Copyright (C) 2014 ApplusForm.com. All rights reserved.
-->
<MOML version="1.1.5" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.applusform.com/xsd/moml_ui_1.1.8.xsd">
	<UILAYOUT portrait="300,300" landscape="300,300">
		<WINDOW id="icon" layout="50,0,200,200" />
		<LABEL id="temperature" layout="0,200,300,100" fontSize="100" textAlign="center"/>
	</UILAYOUT>

	<CMD cmd="function.updateByCountry" />
	<CMD cmd="function.updateByGps" />

	<FUNCTION id="updateByCountry" >
		<CMD cmd="url = 'http://api.openweathermap.org/data/2.5/weather?mode=xml&amp;q=,' + device.os.country" />
		<CMD cmd="xml = file.read(url)" />
		<CMD cmd="kelvin = xpath.evaluateEx(xml, '/current/temperature/@value')" />
		<CMD cmd="celsius = string.format('%.0f', kelvin-273.15)" />
		<CMD cmd="temperature.text = celsius + ' °C'" />
		<CMD cmd="iconName = xpath.evaluateEx(xml, '/current/weather/@icon')" />
		<CMD cmd="icon.img = 'http://openweathermap.org/img/w/' + iconName + '.png'" />
	</FUNCTION>
	
	<FUNCTION id="updateByGps" >
		<CMD cmd="device.gps.addEventListener('onChange', 'function.onGpsChange')" />
		<CMD cmd="device.gps.start"/>
	</FUNCTION>

	<FUNCTION id="onGpsChange(latitude, longitude)">
		<RETURN condition="latitude == 0 and longitude == 0"/>
		<CMD cmd="saveVariable.lastLatitude = latitude"/>
		<CMD cmd="saveVariable.lastLongitude = longitude"/>
		<CMD cmd="url = 'http://api.openweathermap.org/data/2.5/weather?mode=xml&amp;lat=' + latitude + '&amp;lon=' + longitude" />
		<CMD cmd="device.gps.removeEventListener('onChange', 'function.onGpsChange')" />
		<CMD cmd="xml = file.read(url)" />
		<CMD cmd="kelvin = xpath.evaluateEx(xml, '/current/temperature/@value')" />
		<CMD cmd="celsius = string.format('%.0f', kelvin-273.15)" />
		<CMD cmd="temperature.text = celsius + ' °C'" />
		<CMD cmd ="icon = xpath.evaluateEx(xml, '/current/weather/@icon')" />
		<CMD cmd="icon.img = 'http://openweathermap.org/img/w/' + icon + '.png'" />
	</FUNCTION>
</MOML>